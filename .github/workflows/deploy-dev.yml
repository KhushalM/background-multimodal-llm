name: Deploy to AWS Development

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

env:
  AWS_REGION: us-east-1
  EC2_INSTANCE_IP: ${{ secrets.DEV_EC2_INSTANCE_IP }}

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Install backend dependencies
      working-directory: ./backend
      run: |
        pip install uv
        uv pip install -e .
    
    - name: Run frontend tests (if available)
      working-directory: ./frontend
      run: |
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          npm test -- --watchAll=false --coverage=false
        else
          echo "No frontend tests found, skipping..."
        fi
    
    - name: Run backend tests (if available)
      working-directory: ./backend
      run: |
        if [ -d "tests" ]; then
          pytest tests/ -v
        else
          echo "No backend tests found, skipping..."
        fi
    
    - name: Lint frontend (if available)
      working-directory: ./frontend
      run: |
        if npm list eslint > /dev/null 2>&1; then
          npm run lint
        else
          echo "No linting configured, skipping..."
        fi
    
    - name: Check backend code format (if available)
      working-directory: ./backend
      run: |
        if pip list | grep -q black; then
          black --check . || echo "Black not configured properly, skipping..."
        else
          echo "Black not installed, skipping format check..."
        fi

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to Development EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ env.EC2_INSTANCE_IP }}
        username: ec2-user
        key: ${{ secrets.DEV_EC2_SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ Starting development deployment..."
          
          # Navigate to app directory
          cd /opt/app
          
          # Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
                      git pull origin master || {
            echo "Failed to pull code, trying to clone fresh..."
            cd /opt
            sudo rm -rf app
            git clone ${{ github.repositoryUrl }} app
            sudo chown -R ec2-user:ec2-user app
            cd app
          }
          
          # Update environment variables with any secrets
          echo "ğŸ” Updating environment variables..."
          if [ ! -f .env ]; then
            echo "Creating default .env file..."
            cat > .env << 'EOF'
          NODE_ENV=development
          REACT_APP_API_URL=http://localhost:8000
          REACT_APP_WS_URL=ws://localhost:8000
          DATABASE_URL=sqlite:///app/dev_database.db
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY || 'placeholder' }}
          GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY || 'placeholder' }}
          HUGGINGFACE_API_TOKEN=${{ secrets.HUGGINGFACE_API_TOKEN || 'placeholder' }}
          SECRET_KEY=dev-secret-key-change-in-production
          CORS_ORIGINS=http://localhost:3000,http://localhost:8000
          EOF
          fi
          
          # Stop existing containers
          echo "ğŸ›‘ Stopping existing containers..."
          docker-compose -f docker-compose.dev.yml down || echo "No containers to stop"
          
          # Build and start new containers
          echo "ğŸ”¨ Building and starting containers..."
          docker-compose -f docker-compose.dev.yml up -d --build
          
          # Wait for services to be ready
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Health check
          echo "ğŸ¥ Running health check..."
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "âœ… Backend is healthy!"
          else
            echo "âŒ Backend health check failed, checking logs..."
            docker-compose -f docker-compose.dev.yml logs backend
            exit 1
          fi
          
          # Check frontend
          if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo "âœ… Frontend is running!"
          else
            echo "âŒ Frontend check failed, checking logs..."
            docker-compose -f docker-compose.dev.yml logs frontend
            echo "âš ï¸  Frontend might still be starting up..."
          fi
          
          # Cleanup old images
          echo "ğŸ§¹ Cleaning up old Docker images..."
          docker image prune -f
          
          echo "ğŸ‰ Development deployment completed!"
          echo "ğŸ“Š Container status:"
          docker-compose -f docker-compose.dev.yml ps
          
          echo ""
          echo "ğŸ”— Access URLs:"
          echo "   Frontend: http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):3000"
          echo "   Backend:  http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8000"
          echo "   Health:   http://$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4):8000/health"

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify deployment status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "âœ… Development deployment successful!"
          echo "ğŸ”— Frontend: http://${{ env.EC2_INSTANCE_IP }}:3000"
          echo "ğŸ”— Backend: http://${{ env.EC2_INSTANCE_IP }}:8000"
        else
          echo "âŒ Development deployment failed!"
          echo "Check the logs above for details."
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Tests failed - fix issues before deploying."
          fi
        fi 